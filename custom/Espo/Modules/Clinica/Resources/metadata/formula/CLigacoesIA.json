{
    "beforeSaveCustomScript": "// Find the latest incoming webhook related to the current record\n$latestWebhookId = record\\findRelatedOne(\n    'CLigacoesIA',                    \n    id,                              \n    'incomingWebhooks',              \n    'createdAt',                     \n    'desc'                           \n);\n\n// Get the payload from the latest webhook\n$payload = ifThen(\n    $latestWebhookId,\n    record\\attribute('IncomingWebhook', $latestWebhookId, 'payload')\n);\n\n// Only proceed if we have a valid payload\n$callStatus = ifThen(\n    $payload && object\\has($payload, \"call\") && object\\has($payload[\"call\"], \"call_status\"),\n    $payload[\"call\"][\"call_status\"]\n);\n\n// Map call_status to your enum values\n$mappedStatus = ifThenElse(\n    $callStatus == \"ongoing\",\n    \"Em Progresso\",\n    ifThenElse(\n        $callStatus == \"ended\",\n        \"Finalizada\",\n        ifThenElse(\n            $callStatus == \"ringing\",\n            \"Ligando\",\n            ifThenElse(\n                $callStatus == \"rejected\",\n                \"Recusada\",\n                ifThenElse(\n                    $callStatus == \"cancelled\",\n                    \"Cancelada\",\n                    status  // Keep current status for unknown values\n                )\n            )\n        )\n    )\n);\n\n// Safe transcript extraction\n$transcriptValue = ifThen(\n    $payload && object\\has($payload, \"call\") && object\\has($payload[\"call\"], \"transcript\"),\n    $payload[\"call\"][\"transcript\"]\n);\n\n// Safe call cost extraction - CONVERT FROM CENTS TO DOLLARS\n$callCostValue = ifThen(\n    $payload && \n    object\\has($payload, \"call\") && \n    object\\has($payload[\"call\"], \"call_cost\") && \n    object\\has($payload[\"call\"][\"call_cost\"], \"combined_cost\"),\n    number\\round($payload[\"call\"][\"call_cost\"][\"combined_cost\"] / 100, 4)\n);\n\n// Safe recording URL extraction\n$recordingUrlValue = ifThen(\n    $payload && object\\has($payload, \"call\") && object\\has($payload[\"call\"], \"recording_url\"),\n    $payload[\"call\"][\"recording_url\"]\n);\n\n// Set your formula results\nname = string\\concatenate(\"Ligação de Feedback - Consulta - \", agendamento.profissionalName,\" <> \",agendamento.pacienteName);\ntranscript = $transcriptValue;\nstatus = $mappedStatus;\ncallCost = $callCostValue;\nrecordingUrl = $recordingUrlValue;"
}
